---
- name: ServiceNow Incident Remediation
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    sn_instance: "https://dev341769.service-now.com"
  
  tasks:
    - name: Display incident information
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "ServiceNow Incident Automation Triggered"
          - "========================================"
          - "Incident Number: {{ incident_number }}"
          - "Description: {{ short_description }}"
          - "Priority: {{ priority }}"
          - "CI: {{ cmdb_ci }}"
          - "State: {{ state }}"
          - "Assigned To: {{ assigned_to }}"
          - "Category: {{ category }}"
          - "sys_id: {{ sys_id }}"
          - "========================================"
    
    - name: Determine remediation action based on incident
      ansible.builtin.set_fact:
        remediation_type: "{{ 'disk_cleanup' if 'disk' in short_description|lower else 'generic' }}"
    
    - name: Execute disk cleanup remediation
      ansible.builtin.debug:
        msg: "Running disk cleanup on {{ cmdb_ci }}"
      when: remediation_type == 'disk_cleanup'
      # Add actual remediation tasks here
    
    - name: Execute generic remediation
      ansible.builtin.debug:
        msg: "Running generic diagnostics on {{ cmdb_ci }}"
      when: remediation_type == 'generic'
      # Add actual remediation tasks here
    
    - name: Update ServiceNow incident with results
      ansible.builtin.uri:
        url: "{{ sn_instance }}/api/now/table/incident/{{ sys_id }}"
        method: PATCH
        headers:
          Content-Type: "application/json"
        user: "{{ SN_USERNAME }}"
        password: "{{ SN_PASSWORD }}"
        force_basic_auth: true
        body_format: json
        body:
          work_notes: "Ansible automation completed at {{ now(utc=true).isoformat() }}"
        validate_certs: false
        status_code: 200
      when: sys_id is defined
      register: servicenow_update

    - name: Log ServiceNow update result
      ansible.builtin.debug:
        msg: "ServiceNow incident {{ incident_number }} updated successfully"
      when: servicenow_update is succeeded

    - name: Close Complete the incident
      servicenow.itsm.incident:
        instance:
          host: "{{ sn_instance }}"
          username: "{{ SN_USERNAME }}"
          password: "{{ SN_PASSWORD }}"
        sys_id: "{{ sys_id }}"
        state: 7 # Closed
        close_code: "Workaround provided"
        close_notes: test
      register: incident_closure

    - name: Print Incident closure info
      ansible.builtin.debug:
        msg: 
          - "======== Incident Closure Information ==========="
          - "Incident Number: {{ incident_closure.record.number }}"
          - "Incident State: {{ incident_closure.record.state }}"
          - "Incident URL: {{ sn_instance }}/incident.do?sys_id={{ incident_closure.record.sys_id }}"
