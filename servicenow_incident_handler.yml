---
- name: ServiceNow Incident Remediation
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    sn_host: "dev341769"
  
  tasks:
    - name: Display incident information
      debug:
        msg: |
          ========================================
          ServiceNow Incident Automation Triggered
          ========================================
          Incident Number: {{ incident_number }} \n
          Description: {{ short_description }} \n
          Priority: {{ priority }} \n
          CI: {{ cmdb_ci }} \n
          State: {{ state }} \n
          Assigned To: {{ assigned_to }} \n
          Category: {{ category }} \n
          sys_id: {{ sys_id }} \n
          ========================================
    
    - name: Determine remediation action based on incident
      set_fact:
        remediation_type: "{{ 'disk_cleanup' if 'disk' in short_description|lower else 'generic' }}"
    
    - name: Execute disk cleanup remediation
      debug:
        msg: "Running disk cleanup on {{ cmdb_ci }}"
      when: remediation_type == 'disk_cleanup'
      # Add actual remediation tasks here
    
    - name: Execute generic remediation
      debug:
        msg: "Running generic diagnostics on {{ cmdb_ci }}"
      when: remediation_type == 'generic'
      # Add actual remediation tasks here
    
    - name: Update ServiceNow incident with results
      uri:
        url: "https://{{ sn_host }}.service-now.com/api/now/table/incident/{{ sys_id }}"
        method: PATCH
        headers:
          Content-Type: "application/json"
        user: "{{ SN_USERNAME }}"
        password: "{{ SN_PASSWORD }}"
        force_basic_auth: true
        body_format: json
        body:
          work_notes: "Ansible automation completed at {{ now(utc=true).isoformat() }}"
        validate_certs: false
        status_code: 200
      when: sys_id is defined
      register: servicenow_update

    - name: Log ServiceNow update result
      debug:
        msg: "ServiceNow incident {{ incident_number }} updated successfully"
      when: servicenow_update is succeeded
